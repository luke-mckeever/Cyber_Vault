# Malware Analysis

## Intro

#### Malware analysis is the process of examining malicious software to understand its behaviour, origin, and impact. 

> N.B. Safety is the most important aspect, as improper handling can lead to infections or data breaches. 
> It is crucial for identifying threats, developing defences, and improving incident response, helping cybersecurity professionals protect systems and data from attacks.

### Appropriate Malware Handling

The most vulnerable time during any malware analysis is when malware is in transit.
moving malware from one machine to another can be dangerous and may pose the risk of accidental detonation. 
There are a number of steps that can be taken to reduce this risk as prevention of not possible

1. Changing the File Type extension - changing a windows executable (.exe) to something inert like ".thisisnotmalware" can ensure that detonating this will not result in an infection
2. Ensure all malware samples are contained within an Archived Zipped file and also password protect these Zip File - (Standard Password: infected )

### Breakdown
Malware Analysis is Always broken down to the four main processes

- Basic Static Analyse 
- Basic Dynamic Analysis
- Advanced Static Analysis 
- Advanced Dynamic Analysis 

Static and dynamic malware analysis are two fundamental techniques used in cybersecurity to examine and understand the behaviour of malware. Here's a brief comparison of the two:

1. **Static Malware Analysis:**
- **Method:** Analyses the malware without executing it. This involves examining the code, binaries, and other static properties of the malware to understand its potential behaviour.
- **Tools:** Disassemblers (like IDA Pro), debuggers (like OllyDbg), and hexadecimal editors.
- **Advantages:** Safe as the malware does not run; can reveal malware intended to avoid detection when active; good for initial quick assessments.
- **Disadvantages:** Less effective against sophisticated malware that uses obfuscation and encryption to hide its true intent; cannot see runtime behaviours.

1. **Dynamic Malware Analysis:**  
- **Method:** Involves executing the malware in a controlled environment (often a virtual machine) to observe its behaviour during runtime.
- **Tools:** Sandboxes (like Cuckoo Sandbox), system monitoring tools (like Process Monitor), and network traffic analyzers (like Wireshark).
- **Advantages:** Can observe actual behaviour as it happens; effective in analysing polymorphic and encrypted malware; can capture system-level interactions and network traffic.
- **Disadvantages:** Riskier as it involves running the malware; sophisticated malware may detect the analysis environment and alter its behaviour.


## Basic Static Analysis 

The process of basic static analysis does not include the detonation of the executable/malware as in the process of **Static** this involves analysing the file without detonation

### Gathering Information
First steps when conducting **Static Analysis** is to gather the information surrounding the file itself such as:

SHA256 File Hash:
MD5 File Hash:
Original File Name:
Current File Name:
File Size:
File Type: 

We can use the following command to assist in extracting the file hash:
```powershell
get-filehash <INSERT FILE NAME> -alg sha256sum
```
^ This will extract the SHA256 hash value of the given file

```powershell
get-filehash <INSERT FILE NAME> -alg md5sum
```
^ This will extract the MD5 hash value of a given file

The above commands are relative to the PowerShell command line alternative methods are utilised with processes such as CMD.

### Submitting file/hash for more available information
The Next step in basic Static Analysis is to submit these file hashes to known malware databases like Virus Total, Malware Bazaar, AnyRun, Hybrid Analysis, etc. 
This will provide a high level overview of the executable and or if it has ever been seen previously.
See the Image below if an example malicious file:
![[Pasted image 20250318071614.png]]

### Identifying strings within malware 

what are strings? - Within programming strings are just a bunch of characters that together make up a word.
In the context of malware analysis, these strings may be a domain, an IP, etc. 

In turn these strings have been embedded into the executable and can be easily analysed if not properly obfuscated. 
These strings may include information used to exfiltrate data or download a second stage payload.

 To extract these **Strings** from an executable we can utilise many tools to assist, one common one is FLOSS.
 
 Which can be utilised as below
```bash
floss <INSERT FILE NAME>
```
^ This will present a dump of all identified strings greater than four characters

Comparing these Strings to other indicator identified throughout the investigation may prove to be crucial for identifying hardcoded indicators (which isn't always the case)

### Breaking down the structure of an executable 

This poses the question, what does an executable or a portable executable look like, 
we know what a text file or a power shell script look like but what is an executable .

In simple terms it is a compiled bunch of bytes, and breaking this down may reveal some information crucial to an investigation.
To break down an executable we can use a tool called **PEview**. 

`PEview` is a tool used primarily in Windows environments to examine the details of Portable Executable (PE) files. These files include executable (.exe), dynamic link libraries (.dll), and other file types used by the Windows operating system.
In the context of malware analysis, tools like PEview are used in static analysis to quickly assess the composition and potential capabilities of a suspicious file without executing it. By examining the PE structure, analysts can identify signs of malware, such as unusual sections, unexpected imports, or exports, and other indicators of compromise.

To use PEview we can download it from [here]([http://wjradburn.com/software/PEview.zip](http://wjradburn.com/software/PEview.zip)
This is a Graphical Tool and not Command line based (which we love) so upon running this tool it will immediately ask you for an executable to examine.

Select which PE to exam and it will immediately load the structure of the binary.
On the right hand side column you will see the binary byte array for the executable, this is literally the PE in it's entirety 
On the left hand side is a handy reference to the different headers that make up the binary 

Headers to Note:
IMAGE_NT_HEADERS > IMAGE_FILE_HEADER > Time Date Stamp   -  This is the time stamp of the initial compile of the code to executable format (N.B this can be illegitimate caution is advised)
IMAGE_SECTION_HEADER .text -  Comparing the virtual size of the binary and the raw size of the binary is a good way to tell if this is a **Packed** binary (This will need converted from HEX)
SECTION .rdata > IMPORT Address Table - This is the Import Address Table, also known as the Windows API Calls table, this will list all windows API calls
	A Great resource to identify malicious API calls is [MalAPI.io](MalAPI.io) an online catalogue of Windows APIs that are commonly used in malware

> A packed binary refers to an executable file that has been compressed or encrypted using a technique known as "packing." This is commonly done to reduce the file size or protect the executable from being easily analysed or reverse-engineered

#### Packed vs Unpacked Malware:
**Unpacked Malware:** This type of malware is in its original form, making it easier for security software to analyse and detect because all its components are visible and straightforward.
**Packed Malware:** Packed malware has been modified using a tool that compresses or encrypts its contents to hide its true nature. This makes it difficult for antivirus programs to detect it directly because the malicious code is concealed.

**How Malware Gets Packed:**
1. **Choosing a Tool:** Malware creators pick a tool that can compress or encrypt the malware effectively.
2. **Packing the Malware:** They run the malware through this tool, which scrambles the data, making it look harmless or confusing to security systems.
3. **Executing the Malware:** The packed malware includes a small piece of code that, when run, unpacks the malware in the computer's memory, allowing it to carry out its harmful activities without ever showing the original malicious code on the hard drive.

In essence, packed malware is tougher to spot and analyse because it’s disguised, whereas unpacked malware is more straightforward and easier to handle for security systems.

#### Combination Analysis

The Amazing tool known as PEstudio is great for basic static analysis as it combines the majority of tools previously referenced,
The tool is able to gather the following information: (Hash values, File type, Compiler timestamp, Indicators, and many more)

Within the indicators section PEstudio is able to evaluate the byte array and strings to extract information that aligns with known attacker indicators, such as malicious API calls or URL references
Within the libraries section of PEstudio this is able to list out the dynamic link libraries utilised in the executable

Another Great utility for a general overview of an executable is **[[Capa]]**
Capa is a tool used in the field of malware analysis and reverse engineering, designed to help security professionals automatically identify the capabilities of executable files. Developed by Mandiant, CAPA operates by inspecting binary files (such as those ending in .exe or .dll) to discover and classify a wide range of features and behaviours that are often seen in malicious software.

To use Capa we can use the following command:
```bash
capa <INSERT FILE NAME>
```

This will present the following output example
![[Pasted image 20250318144758.png]]


## Basic Dynamic Analysis

Basic dynamic analysis is the process of examining executable files or malware by running them in a controlled environment to observe their behaviours and interactions with the system and network.

Dynamic malware analysis can be broken down into two primary components based on the types of data collected during the analysis: host-based indicators and network-based indicators. Here’s how each plays a crucial role in understanding and identifying malware activities:

1. **Host-Based Indicators:** - These are the signs and signals of malicious activity that can be observed on the computer where the malware is executed. Host-based indicators provide insights into how the malware interacts with the system’s files, registry, processes, and other critical components.
 **Examples:** File Modifications, Registry Changes, Process Behaviour, System Logs, Memory Anomalies
 
2. **Network-Based Indicators:** - These indicators capture the interactions between the malware and network resources, revealing how the malware communicates, propagates, or exfiltrates data.
**Examples:** Network Traffic, DNS Requests, HTTP Requests, Port Activity

#### The Setup 

When preforming Dynamic Analysis of an executable it is important to ensure your tooling is established and ready to analyse the malware 
In some cases malware may attempt to delete itself, if this is the case we require active tools to detect why this was the case and later attempt to debug it.

#### Network Based Indicators

When detonating a malware sample or executable it is common for the malware to reach out to an external domain, this may be for a number of reasons
- Second Stage Payload
- Exfiltration of Data
- etc
A Great tool for detecting these network requests is Wireshark, as it can identify the application that issued the request, and later we can add these requests to an IPS or create YARA rules 

#### Host Based Indicators

When detonating a malware sample or executable it is common for the malware to create sub-processes that carry out specific functions for the malware 
A great tool for detecting these processes is **Procmon** a.k.a. Process Monitor, this will be able to show the analyst which processes spawned as a result of execution

When using this tool, it is recommended to filter by the processes name, this will assist in identifying exactly what the process spawns upon execution 
This will also ensure no other Windows processes are mixed in with the ones spawned.

Just Like many EDR/XDR solutions Procmon also has the utility to graphically map parent - child process relationships, utilising the Process Tree section of the application
This will allow the analyst to identify any spawned processes from the initial execution of the sample.
This can also assist with identifying the Process ID of the malware in order to filter by this to see other processes spawned 

##### Identifying Reverse/Bind Shells

One of the most common types of malware is a RAT or remote access trojan, in this instance a shell is spawned on the victims machine which allows for command injection by the attacker. many techniques are deployed for this to be successful and in some instances these RAT's are established as persistent either in the the victims auto-runs or start-up directory.

To identify these shells we can use tools like [[TCP view]] to assist in identifying connection spawned on suspicious ports by the parent malicious executable.
Another tool that can assist with identifying these connection is Procmon, and can essentially do the same thing as TCPview

If it is the case where we can identify that a sample is preforming a DNS query to initialise a connection to a potential C2 but as we are in a segmented environment this connection will never occur especially because it is done so utilising DNS quires, we can do some trickery and spoof the malware into thinking the domain it is querying is actually the host that it is on (Teehee). this DNS request can be obtained from tools such as Wireshark

How to spoof the etc/hosts file for malicious DNS queries:
Built into Cmder is the Nano text editor, we can use this to edit the hosts file on the Flare VM host using the following command:

```sh
nano C:\Windows\System32\drivers\etc\hosts
```

The cool thing about our Flare VM is that it has the best of both Windows and Linux (intentionally) so the hosts file can be edited to contain domain names and have them associated with IP addresses.

To associate a domain with the host VM we can input the following into the hosts file:

```text
127.0.0.1 <NAME OF MALICIOUS DNS QUERY DOMAIN>
```
^ CTRL + O (to write to the file), Enter (to confirm), CTRL + X (to save and exit the editor)

To further identify the meaning behind this DNS request we can use tools such as Procmon


## Advanced Static Analysis

The first stage of advanced static analysis is being able to understand the binary in a low level
This means converting the many many bits ("1's" and "0's") that make up such an executable / application

To convert these so called bit's into readable format we can use a tools known as [Cutter](https://github.com/luke-mckeever/Cyber_Vault/blob/main/Tooling/Blue%20Team%20Tools/Cutter.md)
This tool will decompile the binary that we would like to investigate, this will then convert the binary into a language known as assembly

> Assembly is a low-level programming language that provides a direct way to write instructions for a computer's CPU. It's closely tied to the hardware and is specific to each processor architecture.

A full breakdown of how to use cutter is located in the tools section of this repo - [HERE](https://github.com/luke-mckeever/Cyber_Vault/blob/main/Tooling/Blue%20Team%20Tools/Cutter.md)

#### Understanding assembly


## Advanced Dynamic Analysis





















### Resources
#### Tools


#### Sources
- PMAT - Labs Malware Samples - Available [Here](https://github.com/HuskyHacks/PMAT-labs/tree/main/labs) 
- Malware Zoo - Live Malware samples - Available [HERE](https://github.com/ytisf/theZoo)  
- Malware Bazaar - Largest Malware sample database - Available [HERE](https://bazaar.abuse.ch/browse/)
- VX Underground - Complete sample and research malware site - Available [HERE](https://vx-underground.org/)
	- Their Git Hub is also available [HERE](https://github.com/vxunderground)